
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Egyptian Sci-Fi Slots</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://js.stripe.com/v3/"></script>
    <link rel="icon" href="images/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="game-container">
        <div class="header">
            <h1>EGYPTIAN WOO-WOO SLOTS</h1> <!-- Fixed quote -->
            <!-- Add Audio Control Button -->
            <div class="audio-control" id="audioControl" title="Toggle Sound">
                <span class="audio-control-icon" id="audioIcon">üîä</span> <!-- Sound On by default -->
            </div>
            <!-- Add Login Section -->
            <div class="login-section" id="loginSection">
                <div id="loginButtons">
                    <button class="login-btn" id="googleLoginBtn">Login with Google</button>
                    <button class="login-btn facebook" id="facebookLoginBtn">Login with Facebook</button>
                    <button class="login-btn tiktok" id="tiktokLoginBtn">Login with TikTok</button>
                </div>
                <div id="userInfo" style="display:none;">
                    <span class="user-info">
                        <img class="user-avatar" id="userAvatar" src="" alt="Avatar">
                        <span id="userName"></span>
                    </span>
                    <button class="btn" id="logoutBtn" style="padding: 5px 10px; font-size: 0.8rem;">Logout</button>
                </div>
                <button class="leaderboard-btn" id="showLeaderboardBtn">View Leaderboard</button>
            </div>
            <!-- Add Spacebar Hint -->
            <div class="spacebar-hint">Press SPACEBAR to SPIN</div>
            <div class="stats-container">
                <div class="stat-box">
                    <div class="stat-label">COINS</div>
                    <div class="stat-value" id="coins">1000</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">BET</div>
                    <div class="stat-value" id="bet">1</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">JACKPOT</div>
                    <div class="stat-value" id="jackpot">10000</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">WINS</div>
                    <div class="stat-value" id="wins">0</div>
                </div>
            </div>
        </div>
        <div class="reels-container" id="reelsContainer">
            <!-- Reels will be generated by JavaScript -->
        </div>
        <div class="bet-controls">
            <button class="bet-btn" onclick="changeBet(-1)">-</button>
            <span>BET: <span id="betDisplay">1</span></span>
            <button class="bet-btn" onclick="changeBet(1)">+</button>
        </div>
        <div class="controls">
            <button class="btn" id="spinBtn" onclick="spin()">SPIN</button>
            <button class="btn" onclick="showShop()">SHOP</button>
            <button class="btn" onclick="showAchievements()">WIN STREAK</button>
        </div>
        <div class="achievements" id="achievementsContainer">
            <!-- Achievements will be shown here -->
        </div>
    </div>
    <div class="overlay" id="shopOverlay">
        <div class="shop-modal">
            <h2 class="shop-title">COIN SHOP</h2>
            <div class="coin-packages">
                <div class="coin-package" data-amount="500" data-price="0.99">
                    <div class="coin-amount">500 COINS</div>
                    <div class="coin-price">$0.99</div>
                </div>
                <div class="coin-package" data-amount="1500" data-price="2.99">
                    <div class="coin-amount">1,500 COINS</div>
                    <div class="coin-price">$2.99</div>
                </div>
                <div class="coin-package" data-amount="4000" data-price="6.99">
                    <div class="coin-amount">4,000 COINS</div>
                    <div class="coin-price">$6.99</div>
                </div>
                <div class="coin-package" data-amount="10000" data-price="14.99">
                    <div class="coin-amount">10,000 COINS</div>
                    <div class="coin-price">$14.99</div>
                </div>
            </div>
            <button class="close-btn" onclick="closeShop()">CLOSE</button>
        </div>
    </div>
    <!-- Leaderboard Overlay -->
    <div class="overlay" id="leaderboardOverlay">
        <div class="leaderboard-modal">
            <h2 class="leaderboard-title">üèÜ LEADERBOARD üèÜ</h2>
            <ul class="leaderboard-list" id="leaderboardList">
                <!-- Leaderboard items will be populated by JavaScript -->
                <li class="leaderboard-item">
                    <span class="leaderboard-rank">-</span>
                    <span class="leaderboard-name">Loading...</span>
                    <span class="leaderboard-score">-</span>
                </li>
            </ul>
            <button class="close-btn" onclick="closeLeaderboard()">CLOSE</button>
        </div>
    </div>
    <!-- Audio elements -->
    <!-- Audio elements (using local files) -->
    <audio id="spinSound" preload="auto">
        <source src="sounds/spin.mp3" type="audio/mpeg">
    </audio>
    <audio id="winSound" preload="auto">
        <source src="sounds/win.mp3" type="audio/mpeg">
    </audio>
    <audio id="jackpotSound" preload="auto">
        <source src="sounds/jackpot.mp3" type="audio/mpeg">
    </audio>
    <audio id="clickSound" preload="auto">
        <source src="sounds/click.mp3" type="audio/mpeg">
    </audio>
    <script>
        // Game state
        const gameState = {
            coins: 1000,
            bet: 1,
            jackpot: 10000,
            wins: 0,
            consecutiveWins: 0,
            lastSpinTime: 0,
            achievements: [],
            symbols: [
                'pharaoh', 'cleopatra', 'pyramid-ship', 'laser-scarab', 
                'hologram-pyramid', 'robot-mummy', 'time-crystal', 
                'quantum-orb', 'lucky-seven', 'star-token'
            ],
            symbolValues: {
                'pharaoh': 50,
                'cleopatra': 40,
                'pyramid-ship': 30,
                'laser-scarab': 25,
                'hologram-pyramid': 20,
                'robot-mummy': 15,
                'time-crystal': 10,
                'quantum-orb': 8,
                'lucky-seven': 5,
                'star-token': 2
            }
        };
        // Audio elements
        const spinSound = document.getElementById('spinSound');
        const winSound = document.getElementById('winSound');
        const jackpotSound = document.getElementById('jackpotSound');
        const clickSound = document.getElementById('clickSound');
        // Play sound function
        function playSound(sound) {
            if (sound) { // Check if sound element exists
                 sound.currentTime = 0;
                 // Check global mute state before playing
                 if (window.isMuted === true) { // Use window.isMuted defined later
                     sound.muted = true;
                 } else {
                     sound.muted = false;
                 }
                 sound.play().catch(e => console.log('Audio play error:', e));
            }
        }
        // Initialize game
        function initGame() {
            loadGameState();
            createReels();
            updateDisplay();
            checkDailyBonus();
             // Handle token from URL hash on load
            window.addEventListener('load', () => {
                const hash = window.location.hash.substring(1); // Remove the '#'
                if (hash) {
                    // Assume the hash contains the JWT token
                    localStorage.setItem('authToken', hash);
                    console.log("Token stored from URL:", hash);
                    // Clear the hash from the URL without reloading
                    history.replaceState(null, null, ' ');
                    // Now fetch user info using the token
                    fetchUserInfo();
                } else {
                     // Check if token exists in localStorage from a previous login
                     const storedToken = localStorage.getItem('authToken');
                     if (storedToken) {
                          fetchUserInfo(); // Fetch user info if token exists
                     }
                }
            });
        }
        // Create reels
        function createReels() {
            const reelsContainer = document.getElementById('reelsContainer');
            reelsContainer.innerHTML = '';
            // Create 3 reels with equal width
            for (let i = 0; i < 3; i++) {
                const reel = document.createElement('div');
                reel.className = 'reel';
                reel.innerHTML = `
                    <div class="symbols-container" id="reel${i}">
                        ${generateSymbols(20)}
                    </div>
                `;
                reelsContainer.appendChild(reel);
            }
        }
        // Generate symbols for reel
        function generateSymbols(count) {
            let symbolsHTML = '';
            for (let i = 0; i < count; i++) {
                const randomSymbol = gameState.symbols[Math.floor(Math.random() * gameState.symbols.length)];
                symbolsHTML += `<div class="symbol" data-symbol="${randomSymbol}"><img src="images/symbols/${randomSymbol}.png" alt="${randomSymbol}" onerror="this.parentElement.innerHTML='<div class=\\'fallback\\'>${randomSymbol.replace('-', ' ')}</div>'"></div>`;
            }
            return symbolsHTML;
        }
        // Spin the reels
        function spin() {
            playSound(spinSound);
            const spinBtn = document.getElementById('spinBtn');
            const coinsNeeded = gameState.bet;
            if (gameState.coins < coinsNeeded) {
                alert('Not enough coins!');
                return;
            }
            // Deduct bet
            gameState.coins -= coinsNeeded;
            gameState.jackpot += coinsNeeded;
            saveGameState();
            updateDisplay();
            spinBtn.disabled = true;
            spinBtn.textContent = 'SPINNING...';
            // Animate reels
            const reels = document.querySelectorAll('.symbols-container');
            const spinResults = [];
            reels.forEach((reel, index) => {
                const spinDuration = 800 + (index * 200); // Faster spins (800ms to 1200ms)
                const symbolHeight = 150; // Fixed height for symbols
                const finalPosition = Math.floor(Math.random() * 15) * -symbolHeight;
                reel.style.transition = `transform ${spinDuration}ms cubic-bezier(0.2, 0.8, 0.3, 1)`;
                reel.style.transform = `translateY(${finalPosition}px)`;
                // Store result for win calculation
                setTimeout(() => {
                    const symbols = reel.querySelectorAll('.symbol');
                    const visibleIndex = Math.floor(Math.abs(finalPosition)/symbolHeight) + 1;
                    const visibleSymbol = symbols[visibleIndex];
                    if (visibleSymbol) {
                        const symbolName = visibleSymbol.getAttribute('data-symbol');
                        spinResults[index] = symbolName || gameState.symbols[0];
                    } else {
                        spinResults[index] = gameState.symbols[0];
                    }
                    if (spinResults.length === 3) {
                        setTimeout(() => checkWin(spinResults), 300); // Faster win check
                    }
                }, spinDuration);
            });
            // Re-enable spin button after animation
            setTimeout(() => {
                spinBtn.disabled = false;
                spinBtn.textContent = 'SPIN';
            }, 1500);
        }
        // Check for wins (Enhanced Celebration)
        function checkWin(results) {
            console.log('Spin results:', results);
            if (results[0] === results[1] && results[1] === results[2]) {
                // Three of a kind - WIN!
                const symbol = results[0];
                const baseWin = gameState.symbolValues[symbol] || 5;
                let winAmount = baseWin * gameState.bet;
                // Apply multiplier for consecutive wins
                if (gameState.consecutiveWins > 0) {
                    const multiplier = Math.min(gameState.consecutiveWins + 1, 5);
                    winAmount *= multiplier;
                }
                gameState.coins += winAmount;
                gameState.wins++;
                gameState.consecutiveWins++;
                playSound(winSound);
                // Jackpot chance (Fixed probability to 1%)
                if (Math.random() < 0.01) { // 1% chance
                    triggerJackpot(); // Jackpot handles its own special effects
                    return; // Exit early if jackpot triggered
                }
                showWinAnimation(winAmount);
                updateDisplay();
                saveGameState();
                checkAchievements();
                // Submit score to backend (if logged in)
                if (window.currentUser) { // Check if user is logged in using global variable
                     submitScoreToBackend(gameState.coins);
                }
                // --- Enhanced Celebration Effects ---
                createBigWinMessage(); // Add the big "YOU WIN!" zoom
                createPaperConfetti(200); // Lots of paper-like confetti
                createBalloons(30); // Add balloons
                createDiscoBalls(10); // Add disco balls
                // --- End Enhanced Celebration Effects ---
            } else {
                gameState.consecutiveWins = 0;
                saveGameState();
            }
        }
        // Trigger jackpot
        function triggerJackpot() {
            playSound(jackpotSound);
            const jackpotAmount = gameState.jackpot;
            gameState.coins += jackpotAmount;
            gameState.jackpot = 10000; // Reset jackpot
            // Show jackpot popup
            const jackpotPopup = document.createElement('div');
            jackpotPopup.className = 'jackpot-popup';
            jackpotPopup.textContent = `JACKPOT! +${jackpotAmount} COINS!`;
            document.body.appendChild(jackpotPopup);
             // Create extra celebration for jackpot
             createPaperConfetti(400);
             createBalloons(50);
             createDiscoBalls(20);
            setTimeout(() => {
                document.body.removeChild(jackpotPopup);
            }, 3000);
            updateDisplay();
            saveGameState();
             // Submit score to backend (if logged in) after jackpot win
            if (window.currentUser) {
                 submitScoreToBackend(gameState.coins);
            }
        }
        // Show win animation
        function showWinAnimation(amount) {
            const coinsDisplay = document.getElementById('coins');
            coinsDisplay.classList.add('win-animation');
            setTimeout(() => {
                coinsDisplay.classList.remove('win-animation');
            }, 2000);
        }
        // Create particle effects (Original, smaller particles)
        function createParticles(count) {
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.top = Math.random() * 100 + '%';
                    particle.style.backgroundColor = `hsl(${Math.random() * 60 + 40}, 100%, 50%)`;
                    particle.style.width = Math.random() * 10 + 5 + 'px';
                    particle.style.height = particle.style.width;
                    document.body.appendChild(particle);
                    // Animate particle
                    const animation = particle.animate([
                        { transform: 'translate(0, 0)', opacity: 1 },
                        { transform: `translate(${Math.random() * 100 - 50}px, ${Math.random() * 100 - 50}px)`, opacity: 0 }
                    ], {
                        duration: Math.random() * 1000 + 1000,
                        easing: 'ease-out'
                    });
                    animation.onfinish = () => particle.remove();
                }, i * 50);
            }
        }
        // Change bet amount
        function changeBet(change) {
            playSound(clickSound);
            const newBet = gameState.bet + change;
            if (newBet >= 1 && newBet <= 10) {
                gameState.bet = newBet;
                updateDisplay();
            }
        }
        // Show shop
        function showShop() {
            playSound(clickSound);
            document.getElementById('shopOverlay').style.display = 'flex';
            // Setup click handlers for coin packages
            document.querySelectorAll('.coin-package').forEach(package => {
                package.addEventListener('click', function() {
                    playSound(clickSound);
                    const amount = this.dataset.amount;
                    const price = this.dataset.price;
                    purchaseCoins(amount, price);
                });
            });
        }
        // Close shop
        function closeShop() {
            playSound(clickSound);
            document.getElementById('shopOverlay').style.display = 'none';
        }
        // Purchase coins function
        function purchaseCoins(amount, price) {
            playSound(clickSound);
            // In a real implementation, this would connect to Stripe
            alert(`Processing purchase: ${amount} coins for $${price}\nIn production, this would redirect to Stripe checkout.`);
            // Simulate successful payment
            setTimeout(() => {
                gameState.coins += parseInt(amount);
                updateDisplay();
                saveGameState();
                closeShop();
                alert(`Purchase successful! ${amount} coins added to your account.`);
                 // Play win sound for successful purchase
                 playSound(winSound);
            }, 2000);
        }
        // Show achievements
        function showAchievements() {
            playSound(clickSound);
            const container = document.getElementById('achievementsContainer');
            if (gameState.achievements.length === 0) {
                container.innerHTML = '<div class="achievement">No achievements yet</div>';
            } else {
                container.innerHTML = gameState.achievements.map(ach => 
                    `<div class="achievement">${ach}</div>`
                ).join('');
            }
        }
        // Check achievements
        function checkAchievements() {
            const achievements = [
                { id: 'first_win', name: 'First Win', condition: () => gameState.wins >= 1 },
                { id: 'ten_wins', name: 'Lucky Ten', condition: () => gameState.wins >= 10 },
                { id: 'big_win', name: 'Big Winner', condition: () => gameState.coins >= 5000 }
            ];
            let newAchievement = false;
            achievements.forEach(ach => {
                if (!gameState.achievements.includes(ach.id) && ach.condition()) {
                    gameState.achievements.push(ach.name);
                    newAchievement = true;
                    alert(`Achievement unlocked: ${ach.name}!`);
                }
            });
            // Play win sound if a new achievement was unlocked
            if (newAchievement) {
                 playSound(winSound);
            }
        }
        // Check daily bonus
        function checkDailyBonus() {
            const now = Date.now();
            const oneDay = 24 * 60 * 60 * 1000;
            if (now - gameState.lastSpinTime > oneDay) {
                gameState.coins += 100;
                gameState.lastSpinTime = now;
                alert('Daily bonus: +100 coins!');
                updateDisplay();
                saveGameState();
                 // Play win sound for daily bonus
                 playSound(winSound);
            }
        }
        // Update display
        function updateDisplay() {
            document.getElementById('coins').textContent = gameState.coins;
            document.getElementById('bet').textContent = gameState.bet;
            document.getElementById('jackpot').textContent = gameState.jackpot;
            document.getElementById('wins').textContent = gameState.wins;
            document.getElementById('betDisplay').textContent = gameState.bet;
        }
        // Save game state
        function saveGameState() {
            localStorage.setItem('egyptianSciFiSlots', JSON.stringify(gameState));
        }
        // Load game state
        function loadGameState() {
            const saved = localStorage.getItem('egyptianSciFiSlots');
            if (saved) {
                const parsed = JSON.parse(saved);
                Object.assign(gameState, parsed);
            }
        }
        // Initialize game when page loads
        // window.addEventListener('load', initGame); // Called inside initGame now
        // Handle window resize
        window.addEventListener('resize', () => {
            setTimeout(createReels, 100);
        });
        // Add click sounds to buttons
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', function(e) {
                    if (e.target.id !== 'spinBtn') {
                        playSound(clickSound);
                    }
                });
            });
        });
        // --- Enhanced Celebration Functions ---
        // Create a large "YOU WIN!" message that zooms in
        function createBigWinMessage() {
            const winMessage = document.createElement('div');
            winMessage.textContent = 'YOU WIN!';
            winMessage.style.position = 'fixed';
            winMessage.style.top = '50%';
            winMessage.style.left = '50%';
            winMessage.style.transform = 'translate(-50%, -50%) scale(0.1)'; // Start small
            winMessage.style.fontSize = '8rem'; // Very large text
            winMessage.style.fontWeight = '900';
            winMessage.style.color = '#ffd700'; // Gold
            winMessage.style.textShadow = '0 0 20px #ff0000, 0 0 40px #0000ff, 0 0 60px #ff00ff'; // Rainbow glow
            winMessage.style.zIndex = '1100'; // On top of everything
            winMessage.style.pointerEvents = 'none';
            winMessage.style.fontFamily = 'Arial Black, sans-serif';
            winMessage.style.whiteSpace = 'nowrap';
            document.body.appendChild(winMessage);
            // Animate the zoom-in and fade-out
            const animation = winMessage.animate([
                { transform: 'translate(-50%, -50%) scale(0.1)', opacity: 0 },
                { transform: 'translate(-50%, -50%) scale(1)', opacity: 1, offset: 0.3 },
                { transform: 'translate(-50%, -50%) scale(1.2)', opacity: 1, offset: 0.7 },
                { transform: 'translate(-50%, -50%) scale(1.5)', opacity: 0 }
            ], {
                duration: 3000, // 3 seconds
                easing: 'cubic-bezier(0.34, 1.56, 0.64, 1)' // Bouncy easing
            });
            animation.onfinish = () => {
                winMessage.remove();
            };
        }
        // Create paper-like confetti (flat, with more variety)
        function createPaperConfetti(count) {
            const colors = ['#ffd700', '#ff6b6b', '#4ecdc4', '#ff9ff3', '#54a0ff', '#ff00ff', '#00ffff', '#ffff00', '#ff5555', '#55ff55'];
            const shapes = ['rect', 'circle']; // Rectangle (paper) and circle
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti'; // Reuse existing class for basic styles
                    // Random position at the top
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.top = '-20px';
                    // Random properties for paper effect
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    const shape = shapes[Math.floor(Math.random() * shapes.length)];
                    const size = Math.random() * 15 + 10; // Larger pieces (10px to 25px)
                    const width = shape === 'rect' ? (Math.random() * 15 + 10) : size;
                    const height = shape === 'rect' ? (Math.random() * 10 + 5) : size; // Rectangles are wider than tall
                    confetti.style.backgroundColor = color;
                    confetti.style.width = width + 'px';
                    confetti.style.height = height + 'px';
                    confetti.style.borderRadius = shape === 'circle' ? '50%' : '0'; // Circle or square/rectangle
                    confetti.style.opacity = '0.9';
                    // Add slight rotation for paper effect
                    const rotation = Math.random() * 360;
                    confetti.style.transform = `rotate(${rotation}deg)`;
                    document.body.appendChild(confetti);
                    // Random falling animation with slight sway
                    const swayDistance = (Math.random() - 0.5) * 100; // Pixels to sway left/right
                    const fallDuration = 3000 + Math.random() * 2000; // 3-5 seconds
                    const animation = confetti.animate([
                        { transform: `translate(0, 0) rotate(${rotation}deg)`, opacity: 1 },
                        { transform: `translate(${swayDistance}px, 100vh) rotate(${rotation + 360}deg)`, opacity: 0.7, offset: 0.8 },
                        { transform: `translate(${swayDistance * 1.5}px, 110vh) rotate(${rotation + 720}deg)`, opacity: 0 }
                    ], {
                        duration: fallDuration,
                        easing: 'cubic-bezier(0.2, 0.8, 0.3, 1)' // Slight bounce at the end
                    });
                    animation.onfinish = () => confetti.remove();
                }, i * 15); // Faster burst
            }
        }
        // Create balloons
        function createBalloons(count) {
            const colors = ['#ffd700', '#ff6b6b', '#4ecdc4', '#ff9ff3', '#54a0ff'];
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const balloon = document.createElement('div');
                    balloon.style.position = 'fixed';
                    balloon.style.bottom = '-50px'; // Start below screen
                    balloon.style.left = Math.random() * 100 + 'vw';
                    balloon.style.width = '40px';
                    balloon.style.height = '50px'; // Oval shape
                    balloon.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    balloon.style.borderRadius = '50% 50% 40% 40%'; // Balloon shape
                    balloon.style.zIndex = '1050';
                    balloon.style.pointerEvents = 'none';
                    balloon.style.opacity = '0.9';
                    // Add balloon string
                    const string = document.createElement('div');
                    string.style.position = 'absolute';
                    string.style.top = '100%';
                    string.style.left = '50%';
                    string.style.width = '1px';
                    string.style.height = '60px';
                    string.style.backgroundColor = '#ccc';
                    string.style.transform = 'translateX(-50%)';
                    balloon.appendChild(string);
                    document.body.appendChild(balloon);
                    // Animate balloon floating up and swaying
                    const swayAmount = (Math.random() - 0.5) * 100;
                    const floatDuration = 8000 + Math.random() * 4000; // 8-12 seconds
                    const animation = balloon.animate([
                        { transform: 'translate(0, 0)', opacity: 1 },
                        { transform: `translate(${swayAmount * 0.5}px, -20vh)`, opacity: 1, offset: 0.3 },
                        { transform: `translate(${swayAmount}px, -50vh)`, opacity: 0.8, offset: 0.6 },
                        { transform: `translate(${swayAmount * 1.5}px, -110vh)`, opacity: 0 }
                    ], {
                        duration: floatDuration,
                        easing: 'ease-in'
                    });
                    animation.onfinish = () => balloon.remove();
                }, i * 100); // Release balloons periodically
            }
        }
        // Create disco balls
        function createDiscoBalls(count) {
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const ball = document.createElement('div');
                    ball.style.position = 'fixed';
                    ball.style.top = Math.random() * 100 + 'vh';
                    ball.style.left = Math.random() * 100 + 'vw';
                    ball.style.width = '30px';
                    ball.style.height = '30px';
                    ball.style.borderRadius = '50%';
                    ball.style.zIndex = '1040';
                    ball.style.pointerEvents = 'none';
                    ball.style.opacity = '0.9';
                    ball.style.boxShadow = 'inset -5px -5px 10px rgba(0,0,0,0.5)'; // Give it dimension
                    // Create disco facets using a pseudo-gradient effect
                    const hue1 = Math.floor(Math.random() * 360);
                    const hue2 = (hue1 + 120) % 360;
                    const hue3 = (hue1 + 240) % 360;
                    ball.style.background = `radial-gradient(circle at 30% 30%, #fff, hsl(${hue1}, 100%, 50%), hsl(${hue2}, 100%, 50%), hsl(${hue3}, 100%, 50%))`;
                    document.body.appendChild(ball);
                    // Animate shimmer and fade
                    const shimmerKeyframes = [];
                    for (let j = 0; j <= 100; j += 10) {
                         const hueShift = (j * 3.6) % 360; // Cycle through hues
                         shimmerKeyframes.push({
                             offset: j / 100,
                             filter: `hue-rotate(${hueShift}deg)`
                         });
                    }
                    const animation = ball.animate(
                        [
                            { transform: 'scale(0) rotate(0deg)', opacity: 0 },
                            { transform: 'scale(1) rotate(180deg)', opacity: 0.9, offset: 0.2 },
                            // Add shimmer keyframes
                            ...shimmerKeyframes.map((kf, idx) => ({
                                ...kf,
                                offset: 0.2 + (idx / shimmerKeyframes.length) * 0.7 // Occur between 20% and 90%
                            })),
                            { transform: 'scale(0) rotate(360deg)', opacity: 0 }
                        ],
                        {
                            duration: 4000 + Math.random() * 2000, // 4-6 seconds
                            easing: 'ease-out'
                        }
                    );
                    animation.onfinish = () => ball.remove();
                }, i * 200); // Release disco balls periodically
            }
        }
        // --- End Enhanced Celebration Functions ---

        // --- New JavaScript for Audio Control, Login, Leaderboard, Spacebar ---
        // --- Audio Control ---
        // Define isMuted globally so playSound can access it
        window.isMuted = false; // Default: sound on
        document.addEventListener('DOMContentLoaded', () => {
             const audioControl = document.getElementById('audioControl');
             const audioIcon = document.getElementById('audioIcon');
             if (audioControl && audioIcon) { // Check if elements exist
                  audioControl.addEventListener('click', () => {
                       window.isMuted = !window.isMuted;
                       audioIcon.textContent = window.isMuted ? 'üîá' : 'üîä';
                       // Update muted state for all audio elements immediately
                       [spinSound, winSound, jackpotSound, clickSound].forEach(sound => {
                            if (sound) { // Check if element exists
                                 sound.muted = window.isMuted;
                            }
                       });
                       console.log(window.isMuted ? 'Audio Muted' : 'Audio Unmuted');
                  });
             }
        });
        // --- End Audio Control ---

        // --- Social Login & User State ---
        // Global variable to hold current user info
        window.currentUser = null;

        // Function to fetch user info using stored token
        async function fetchUserInfo() {
            const token = localStorage.getItem('authToken');
            if (!token) return;
            try {
                const response = await fetch('http://localhost:8000/api/user/me', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (response.ok) {
                    const userData = await response.json();
                    window.currentUser = userData; // Update global currentUser variable
                    updateUIForLogin(); // Update UI to show logged-in state
                    console.log("User info fetched:", userData);
                } else {
                    console.error("Failed to fetch user info:", response.status);
                    // Handle error (e.g., token expired, logout)
                    if (response.status === 401) {
                        logout(); // Logout if unauthorized
                    }
                }
            } catch (error) {
                console.error("Error fetching user info:", error);
            }
        }

        // Function to update UI based on login state (global currentUser)
        function updateUIForLogin() {
             const loginButtons = document.getElementById('loginButtons');
             const userInfo = document.getElementById('userInfo');
             const userName = document.getElementById('userName');
             const userAvatar = document.getElementById('userAvatar');

             if (window.currentUser && loginButtons && userInfo && userName && userAvatar) {
                 userName.textContent = window.currentUser.name || 'User';
                 // Use avatar_url if provided by backend, otherwise generate
                 const avatarUrl = window.currentUser.avatar_url || `https://api.dicebear.com/7.x/initials/svg?seed=${encodeURIComponent(window.currentUser.name || 'U')}`;
                 userAvatar.src = avatarUrl;
                 userAvatar.alt = `${window.currentUser.name}'s avatar`;
                 loginButtons.style.display = 'none';
                 userInfo.style.display = 'flex';
             } else if (loginButtons && userInfo) {
                 loginButtons.style.display = 'block';
                 userInfo.style.display = 'none';
             }
        }

        // Logout function
        function logout() {
            localStorage.removeItem('authToken');
            window.currentUser = null;
            updateUIForLogin();
            console.log('Logged out');
            // alert('Logout successful!');
            playSound(clickSound); // Play sound on logout click
        }

        // Event listeners for login/logout buttons (after DOM is loaded)
        document.addEventListener('DOMContentLoaded', () => {
             const googleLoginBtn = document.getElementById('googleLoginBtn');
             const facebookLoginBtn = document.getElementById('facebookLoginBtn');
             const tiktokLoginBtn = document.getElementById('tiktokLoginBtn');
             const logoutBtn = document.getElementById('logoutBtn');

             if (googleLoginBtn) {
                  googleLoginBtn.addEventListener('click', () => {
                      window.location.href = 'http://localhost:8000/auth/google/login'; // Point to your backend
                  });
             }
             if (facebookLoginBtn) {
                  // Placeholder for Facebook login - replace with actual backend endpoint
                  facebookLoginBtn.addEventListener('click', () => {
                      alert('Facebook login not implemented yet.');
                      // simulateLogin('Facebook');
                  });
             }
             if (tiktokLoginBtn) {
                  // Placeholder for TikTok login - replace with actual backend endpoint
                  tiktokLoginBtn.addEventListener('click', () => {
                      alert('TikTok login not implemented yet.');
                      // simulateLogin('TikTok');
                  });
             }
             if (logoutBtn) {
                  logoutBtn.addEventListener('click', logout);
             }

             // Initial UI update in case user is already logged in
             // fetchUserInfo is called in initGame on window load
             updateUIForLogin();
        });

        // Simulate login function (for testing UI, remove when backend is ready)
        /*
        function simulateLogin(provider) {
            console.log(`Initiating simulated login with ${provider}...`);
            setTimeout(() => {
                window.currentUser = {
                    name: `Player_${Math.floor(Math.random() * 1000)}`,
                    avatar_url: `https://api.dicebear.com/7.x/initials/svg?seed=${provider}`
                };
                updateUIForLogin();
                console.log(`Simulated login as ${window.currentUser.name} via ${provider}`);
                alert(`Simulated login with ${provider} successful! Welcome, ${window.currentUser.name}`);
            }, 500);
        }
        */
        // --- End Social Login ---

        // --- Leaderboard ---
        // Function to show leaderboard overlay
        function showLeaderboard() {
            const leaderboardOverlay = document.getElementById('leaderboardOverlay');
            if (leaderboardOverlay) {
                 leaderboardOverlay.style.display = 'flex';
                 loadLeaderboardData(); // Fetch data when opening
            }
            playSound(clickSound); // Play sound on button click
        }

        // Function to close leaderboard overlay
        function closeLeaderboard() {
            const leaderboardOverlay = document.getElementById('leaderboardOverlay');
            if (leaderboardOverlay) {
                 leaderboardOverlay.style.display = 'none';
            }
            playSound(clickSound); // Play sound on button click
        }

        // Function to load leaderboard data from backend
        async function loadLeaderboardData() {
            const leaderboardList = document.getElementById('leaderboardList');
            if (!leaderboardList) return;

            console.log("Fetching leaderboard data from backend...");
            leaderboardList.innerHTML = '<li class="leaderboard-item"><span>Loading...</span></li>'; // Show loading

            try {
                const response = await fetch('http://localhost:8000/api/leaderboard?limit=10');
                if (response.ok) {
                    const rawData = await response.json();
                    // Process data to match expected format (rank, name, score)
                    // Assuming backend returns [{user_id, name, avatar_url, score}]
                    const data = rawData.map((item, index) => ({
                         rank: index + 1,
                         name: item.name || 'Unknown',
                         avatar_url: item.avatar_url || '',
                         score: item.score || 0,
                         user_id: item.user_id // Keep user_id for comparison
                    }));
                    updateLeaderboardList(data);
                } else {
                     throw new Error(`HTTP error! status: ${response.status}`);
                }
            } catch (error) {
                console.error('Error fetching leaderboard:', error);
                leaderboardList.innerHTML = '<li class="leaderboard-item"><span>Error loading leaderboard</span></li>';
            }
        }

        // Function to update the leaderboard list UI
        function updateLeaderboardList(data) {
            const leaderboardList = document.getElementById('leaderboardList');
            if (!leaderboardList) return;

            leaderboardList.innerHTML = ''; // Clear existing list
            if (!data || data.length === 0) {
                leaderboardList.innerHTML = '<li class="leaderboard-item"><span>No data available</span></li>';
                return;
            }

            data.forEach(player => {
                const listItem = document.createElement('li');
                listItem.className = 'leaderboard-item';
                // Highlight current user
                if (window.currentUser && player.user_id == window.currentUser.id) { // Use == for potential type difference
                    listItem.style.backgroundColor = 'rgba(255, 215, 0, 0.1)';
                    listItem.style.border = '1px solid #ffd700';
                    listItem.style.borderRadius = '5px';
                }
                listItem.innerHTML = `
                    <span class="leaderboard-rank">${player.rank}</span>
                    <span class="leaderboard-name">${player.name}</span>
                    <span class="leaderboard-score">${parseInt(player.score).toLocaleString()}</span>
                `;
                leaderboardList.appendChild(listItem);
            });
        }

        // Event listener for show leaderboard button (after DOM is loaded)
        document.addEventListener('DOMContentLoaded', () => {
             const showLeaderboardBtn = document.getElementById('showLeaderboardBtn');
             if (showLeaderboardBtn) {
                  showLeaderboardBtn.addEventListener('click', showLeaderboard);
             }
        });
        // --- End Leaderboard ---

        // --- Spacebar to Spin ---
        let isSpacebarCooldown = false; // Prevent rapid spinning
        document.addEventListener('keydown', (event) => {
            if (event.code === 'Space' && !isSpacebarCooldown) {
                event.preventDefault(); // Prevent space from scrolling the page
                const spinBtn = document.getElementById('spinBtn');
                if (spinBtn && !spinBtn.disabled) {
                    spin(); // Trigger spin
                    isSpacebarCooldown = true;
                    setTimeout(() => { isSpacebarCooldown = false; }, 1000); // 1 second cooldown
                }
            }
        });
        // --- End Spacebar to Spin ---

        // --- Backend Score Submission ---
        async function submitScoreToBackend(score) {
            const token = localStorage.getItem('authToken');
            if (!token) return; // Don't submit if not logged in

            try {
                const response = await fetch('http://localhost:8000/api/scores', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ score_value: parseInt(score) }) // Ensure it's an integer
                });
                if (response.ok) {
                    const data = await response.json();
                    console.log("Score submitted successfully:", data);
                } else {
                    console.error("Failed to submit score:", response.status, await response.text());
                }
            } catch (error) {
                console.error("Error submitting score:", error);
            }
        }
        // --- End Backend Score Submission ---

        // Call initGame to start the process
        initGame();
    </script>
</body>
</html>
```
